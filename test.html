<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>论文阅读笔记登录</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 400px;
            margin: auto;
            text-align: center;
        }

        input,
        button {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
        }

        #noteApp {
            display: none;
        }

        #saveNote,
        #clearNote {
            display: none;
        }

        /* 正文内容样式 */
        #content {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            box-sizing: border-box;
            text-align: left;
            min-height: 100px;
            resize: vertical;
            border: 1px solid #ddd;
        }

        /* 返回顶部按钮样式 */
        #backToTop {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            width: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: none;
        }

        /* 搜索框样式 */
        #searchContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        #searchInput {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #delete {
            position: absolute;
            top: 1px;
            left: 1px;
            width: 40px;
            padding: 2px;
        }

        /* 模态框样式 */
        #modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #modalContent {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 5px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        #closeModal {
            margin-top: 10px;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container" id="loginForm">
        <h2>登录到笔记</h2>
        <input type="text" id="username" placeholder="账号">
        <input type="password" id="password" placeholder="密码">
        <button onclick="login()">登录</button>
    </div>

    <div class="container" id="noteApp">
        <h2>笔记</h2>
        <label for="title">题目：</label>
        <input type="text" id="title" placeholder="输入题目">
        <label for="tags">标签：</label>
        <input type="text" id="tags" placeholder="输入标签（用逗号分隔）">
        <label for="content">正文：</label>
        <div id="content" contenteditable="true" placeholder="在此粘贴图片或输入文本内容"></div>
        <button id="saveNote" onclick="saveNote()">保存</button>
        <button onclick="loadNote()">加载</button>
        <button id="clearNote" onclick="clearNote()">清除</button>
        <h3>已保存的笔记</h3>
        <div id="savedNotes"></div>
        <!-- 搜索框 -->
        <div id="searchContainer">
            <input type="text" id="searchInput" placeholder="搜索笔记..." oninput="filterNotes()">
        </div>
    </div>

    <!-- 返回顶部按钮 -->
    <button id="backToTop" onclick="scrollToTop()">回到顶部</button>

    <!-- Supabase Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script type="module" defer>
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const SUPABASE_URL = 'https://trkbnxkkegwrhnboidwi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRya2JueGtrZWd3cmhuYm9pZHdpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk0MDE4MzQsImV4cCI6MjA0NDk3NzgzNH0.wlFGKI03di0llAcuqUtTC5YUDt_pt05o_VySxECj2F0';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let isAdmin = false;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const { data: users, error } = await supabase
                .from('new')
                .select('acc, pwd')
                .eq('acc', username)
                .eq('pwd', password);

            if (error) {
                console.error('登录失败：', error);
                showModal('登录出错，请稍后重试');
            } else if (users.length > 0) {
                showModal('登录成功');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('noteApp').style.display = 'block';

                // 检查是否为管理员
                isAdmin = username === '2191453326';
                document.getElementById('saveNote').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('clearNote').style.display = isAdmin ? 'block' : 'none';
            } else {
                showModal('账号或密码错误');
            }
        }

        async function saveNote() {
            if (!isAdmin) {
                showModal('您没有权限保存笔记');
                return;
            }

            const title = document.getElementById('title').value;
            const tags = document.getElementById('tags').value;
            const content = document.getElementById('content').innerHTML;

            if (title && tags && content) {
                const createdAt = new Date().toISOString(); // 获取当前时间
                const note = {
                    title: title,
                    kind: tags.split(',').map(tag => tag.trim()).join(','),
                    text: content,
                    created_at: createdAt // 添加创建时间
                };

                const { error } = await supabase
                    .from('self')
                    .insert(note);

                if (error) {
                    console.error('保存失败:', error);
                    showModal('笔记保存失败');
                } else {
                    showModal('笔记已保存');
                    loadNote();
                }
            } else {
                showModal('请填写所有字段');
            }
        }

        async function loadNote() {
            const savedNotes = document.getElementById('savedNotes');
            savedNotes.innerHTML = '';

            const { data: notes, error } = await supabase
                .from('self')
                .select('id, title, kind, text, created_at'); // 获取ID以便删除

            if (error) {
                console.error('加载失败:', error);
                showModal('加载笔记失败');
                return;
            }

            notes.forEach(note => {
                const noteDiv = document.createElement('div');
                noteDiv.style.border = '1px solid #ddd';
                noteDiv.style.marginBottom = '10px';
                noteDiv.style.padding = '5px';
                noteDiv.style.position = 'relative';
                noteDiv.style.height = '150px';
                noteDiv.style.overflowY = 'auto';
                noteDiv.style.overflowWrap = 'normal'
                noteDiv.innerHTML =
                    `<strong>${note.title}</strong><br>
                    <strong style="float: right; text-align: right;">分类标签：${note.kind}</strong><br>
                    <br>
                    <strong style="float: left;"></strong>
                    <div style="clear: both; text-align: left;">${note.text}</div>
                    <br>
                    <span style="position: absolute; bottom: 5px; right: 5px;">${note.created_at}</span>
                    <button style="position: absolute; top: 5px; left: 5px;" onclick="deleteNote(${note.id})">删除</button>
                `;
                savedNotes.appendChild(noteDiv);
            });
        }

        // 更新 deleteNote 函数以显示确认模态框
        async function deleteNote(noteId) {
            if (!isAdmin) {
                showModal('您没有权限删除笔记');
                return;
            }

            // 显示确认模态框
            const modalContent = `
                    <p>您确定要删除此笔记吗？</p>
                    <button id="confirmDelete" onclick="confirmDeleteNote(${noteId})">确认删除</button>
                    <button onclick="closeModal()">取消</button>
                `;
            showModal(modalContent);
        }

        // 确认删除笔记
        async function confirmDeleteNote(noteId) {
            const { error } = await supabase
                .from('self')
                .delete()
                .eq('id', noteId);

            if (error) {
                console.error('删除失败:', error);
                showModal('笔记删除失败');
            } else {
                showModal('笔记已删除');
                loadNote();
            }
        }

        function clearNote() {
            document.getElementById('title').value = '';
            document.getElementById('tags').value = '';
            document.getElementById('content').innerHTML = '';
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 筛选笔记
        function filterNotes() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const savedNotes = document.getElementById('savedNotes');
            const notes = savedNotes.getElementsByTagName('div');

            Array.from(notes).forEach(note => {
                const title = note.getElementsByTagName('strong')[0].textContent.toLowerCase();
                if (title.includes(searchInput)) {
                    note.style.display = 'block';
                } else {
                    note.style.display = 'none';
                }
            });
        }

        // 显示模态框
        function showModal(content) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = content; // 插入 HTML 内容
            modal.style.display = 'block'; // 显示模态框
        }

        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.style.display = 'none'; // 隐藏模态框
        }
        // 窗口关闭事件
        window.onclick = function (event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // 监听键盘事件以关闭模态框
        document.onkeydown = function (event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        }

        // 监听滚动以显示/隐藏返回顶部按钮
        window.onscroll = function () {
            const backToTop = document.getElementById('backToTop');
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backToTop.style.display = 'block';
            } else {
                backToTop.style.display = 'none';
            }
        }
        window.onload = loadNote;
        window.loadNote = loadNote;
        window.login = login;
        window.saveNote = saveNote;
        window.clearNote = clearNote;
        window.filterNotes = filterNotes;
        window.deleteNote = deleteNote;
        window.scrollToTop = scrollToTop;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.confirmDeleteNote = confirmDeleteNote

    </script>

    <!-- 模态框 -->
    <div id="modal">
        <div id="modalContent">
            <p>信息提示</p>
            <button id="closeModal" onclick="closeModal()">关闭</button>
        </div>
    </div>
</body>

</html>